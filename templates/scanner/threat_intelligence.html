{% extends 'scanner/base.html' %}

{% block title %}Threat Intelligence - ZtionSec{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5 fw-bold text-primary">
                        <i class="fas fa-brain"></i> Threat Intelligence
                    </h1>
                    <p class="lead text-muted">Real-time threat indicators and intelligence feeds</p>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addIndicatorModal">
                        <i class="fas fa-plus"></i> Add Indicator
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" name="search" 
                                       placeholder="Search indicators, IPs, domains...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" name="type">
                                <option value="">All Types</option>
                                {% for type_code, type_name in indicator_types %}
                                    <option value="{{ type_code }}" {% if selected_type == type_code %}selected{% endif %}>
                                        {{ type_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h4>{{ indicators|length }}</h4>
                    <p class="mb-0">Active Indicators</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-globe fa-2x mb-2"></i>
                    <h4>0</h4>
                    <p class="mb-0">IP Addresses</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-link fa-2x mb-2"></i>
                    <h4>0</h4>
                    <p class="mb-0">Domains</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-shield-alt fa-2x mb-2"></i>
                    <h4>Live</h4>
                    <p class="mb-0">Feed Status</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Threat Intelligence Feeds -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-rss"></i> Intelligence Feeds
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="feed-status">
                                <i class="fas fa-check-circle fa-2x text-success"></i>
                                <h6 class="mt-2">AlienVault OTX</h6>
                                <small class="text-muted">Active</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="feed-status">
                                <i class="fas fa-check-circle fa-2x text-success"></i>
                                <h6 class="mt-2">Abuse.ch</h6>
                                <small class="text-muted">Active</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="feed-status">
                                <i class="fas fa-exclamation-circle fa-2x text-warning"></i>
                                <h6 class="mt-2">VirusTotal</h6>
                                <small class="text-muted">API Key Required</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="feed-status">
                                <i class="fas fa-check-circle fa-2x text-success"></i>
                                <h6 class="mt-2">Custom Feeds</h6>
                                <small class="text-muted">Active</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicators Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Threat Indicators
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if indicators %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Type</th>
                                        <th>Indicator</th>
                                        <th>Threat Type</th>
                                        <th>Confidence</th>
                                        <th>Source</th>
                                        <th>First Seen</th>
                                        <th>Last Seen</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for indicator in indicators %}
                                    <tr>
                                        <td>
                                            <span class="badge 
                                                {% if indicator.indicator_type == 'ip' %}bg-danger
                                                {% elif indicator.indicator_type == 'domain' %}bg-warning
                                                {% elif indicator.indicator_type == 'url' %}bg-info
                                                {% else %}bg-secondary{% endif %}">
                                                {{ indicator.get_indicator_type_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <code class="text-dark">{{ indicator.indicator_value|truncatechars:50 }}</code>
                                        </td>
                                        <td>
                                            {% if indicator.threat_type %}
                                                <span class="badge bg-primary">{{ indicator.threat_type }}</span>
                                            {% else %}
                                                <span class="text-muted">Unknown</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-2" style="width: 60px; height: 8px;">
                                                    <div class="progress-bar 
                                                        {% if indicator.confidence_level >= 80 %}bg-success
                                                        {% elif indicator.confidence_level >= 60 %}bg-warning
                                                        {% else %}bg-danger{% endif %}" 
                                                        style="width: {{ indicator.confidence_level }}%"></div>
                                                </div>
                                                <small>{{ indicator.confidence_level }}%</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ indicator.source }}</span>
                                        </td>
                                        <td>
                                            <small>{{ indicator.first_seen|date:"M d, Y" }}</small>
                                        </td>
                                        <td>
                                            <small>{{ indicator.last_seen|date:"M d, Y" }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-info" 
                                                        onclick="showIndicatorDetails('{{ indicator.id }}')" 
                                                        title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" 
                                                        onclick="investigateIndicator('{{ indicator.indicator_value }}')" 
                                                        title="Investigate">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" 
                                                        onclick="blockIndicator('{{ indicator.id }}')" 
                                                        title="Block">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {% if indicators.has_other_pages %}
                        <div class="card-footer">
                            <nav aria-label="Indicators pagination">
                                <ul class="pagination justify-content-center mb-0">
                                    {% if indicators.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ indicators.previous_page_number }}">Previous</a>
                                        </li>
                                    {% endif %}
                                    
                                    {% for num in indicators.paginator.page_range %}
                                        {% if indicators.number == num %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                        {% elif num > indicators.number|add:'-3' and num < indicators.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if indicators.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ indicators.next_page_number }}">Next</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-brain fa-4x text-muted mb-4"></i>
                            <h4>No Threat Indicators</h4>
                            <p class="text-muted">No threat intelligence data available. Data will be populated during scans.</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addIndicatorModal">
                                <i class="fas fa-plus"></i> Add First Indicator
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Indicator Modal -->
<div class="modal fade" id="addIndicatorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Add Threat Indicator
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="indicatorForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="indicatorType" class="form-label">Indicator Type</label>
                        <select class="form-select" id="indicatorType" required>
                            <option value="">Select Type</option>
                            <option value="ip">IP Address</option>
                            <option value="domain">Domain</option>
                            <option value="url">URL</option>
                            <option value="hash">File Hash</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="indicatorValue" class="form-label">Indicator Value</label>
                        <input type="text" class="form-control" id="indicatorValue" 
                               placeholder="e.g., 192.168.1.1, malicious.com" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="threatType" class="form-label">Threat Type</label>
                        <input type="text" class="form-control" id="threatType" 
                               placeholder="e.g., malware, phishing, botnet">
                    </div>
                    
                    <div class="mb-3">
                        <label for="confidenceLevel" class="form-label">Confidence Level</label>
                        <input type="range" class="form-range" id="confidenceLevel" 
                               min="0" max="100" value="75" oninput="updateConfidenceValue(this.value)">
                        <div class="d-flex justify-content-between">
                            <small>Low (0%)</small>
                            <small id="confidenceValue">75%</small>
                            <small>High (100%)</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="source" class="form-label">Source</label>
                        <input type="text" class="form-control" id="source" 
                               placeholder="e.g., Manual Entry, OSINT" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Add Indicator
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Indicator Details Modal -->
<div class="modal fade" id="indicatorDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle"></i> Indicator Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="indicatorDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="investigateCurrentIndicator()">
                    <i class="fas fa-search"></i> Investigate
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateConfidenceValue(value) {
    document.getElementById('confidenceValue').textContent = value + '%';
}

function showIndicatorDetails(indicatorId) {
    // Show indicator details in modal
    document.getElementById('indicatorDetailsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading indicator details...</p>
        </div>
    `;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('indicatorDetailsModal')).show();
    
    // Simulate loading (in real implementation, this would fetch from API)
    setTimeout(() => {
        document.getElementById('indicatorDetailsContent').innerHTML = `
            <div class="row">
                <div class="col-12">
                    <h6>Indicator ID: ${indicatorId}</h6>
                    <p class="text-muted">Detailed threat intelligence information would be displayed here.</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        This feature will be fully implemented with real-time threat intelligence data.
                    </div>
                </div>
            </div>
        `;
    }, 1000);
}

function investigateIndicator(indicatorValue) {
    showComingSoon(
        'Investigation Feature Coming Soon!',
        `Advanced investigation tools for "${indicatorValue}" will be available in the next update.`,
        'Version 2.1'
    );
}

function blockIndicator(indicatorId) {
    showConfirm(
        'Block Threat Indicator',
        'Are you sure you want to block this threat indicator? This action will add it to your blocklist.',
        () => {
            showLoading('Blocking Indicator', 'Adding indicator to blocklist...');
            
            // Simulate API call
            setTimeout(() => {
                hideLoading();
                showSuccess(
                    'Indicator Blocked Successfully',
                    `Threat indicator has been added to your blocklist and will be monitored.`
                );
            }, 2000);
        }
    );
}

function investigateCurrentIndicator() {
    showComingSoon(
        'Investigation Tools Coming Soon!',
        'Advanced threat investigation and correlation tools are under development.',
        'Version 2.1'
    );
}

// Handle form submission
document.getElementById('indicatorForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const indicatorValue = document.getElementById('indicatorValue').value;
    const indicatorType = document.getElementById('indicatorType').value;
    
    showLoading('Adding Threat Indicator', 'Processing new threat intelligence...');
    
    // Simulate API call
    setTimeout(() => {
        hideLoading();
        showSuccess(
            'Threat Indicator Added Successfully',
            `${indicatorType} indicator "${indicatorValue}" has been added to your threat intelligence database.`
        );
        
        // Close modal and reset form
        bootstrap.Modal.getInstance(document.getElementById('addIndicatorModal')).hide();
        document.getElementById('indicatorForm').reset();
    }, 2000);
});

// Auto-refresh threat intelligence data every 2 minutes
setInterval(() => {
    console.log('Auto-refreshing threat intelligence data...');
    // Implementation for auto-refresh
}, 120000);
</script>
{% endblock %}
