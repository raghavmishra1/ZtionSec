{% extends 'scanner/base.html' %}

{% block title %}Scan Configurations - ZtionSec{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5 fw-bold text-primary">
                        <i class="fas fa-cogs"></i> Scan Configurations
                    </h1>
                    <p class="lead text-muted">Manage and customize security scanning profiles</p>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createConfigModal">
                        <i class="fas fa-plus"></i> Create Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Cards -->
    <div class="row">
        {% if configurations %}
            {% for config in configurations %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 {% if config.is_default %}border-primary{% endif %}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ config.name }}</h5>
                        {% if config.is_default %}
                            <span class="badge bg-primary">Default</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <p class="card-text">{{ config.description|default:"No description provided" }}</p>
                        
                        <div class="mb-3">
                            <h6>Enabled Features:</h6>
                            <div class="d-flex flex-wrap gap-1">
                                {% if config.enable_port_scan %}
                                    <span class="badge bg-success">Port Scan</span>
                                {% endif %}
                                {% if config.enable_vulnerability_scan %}
                                    <span class="badge bg-success">Vulnerability Scan</span>
                                {% endif %}
                                {% if config.enable_webapp_scan %}
                                    <span class="badge bg-success">Web App Scan</span>
                                {% endif %}
                                {% if config.enable_subdomain_enum %}
                                    <span class="badge bg-success">Subdomain Enum</span>
                                {% endif %}
                                {% if config.enable_threat_intel %}
                                    <span class="badge bg-success">Threat Intel</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Port Range:</small><br>
                                <code>{{ config.port_scan_range }}</code>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Timeout:</small><br>
                                <code>{{ config.scan_timeout }}s</code>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="btn-group w-100">
                            <button class="btn btn-outline-primary btn-sm" onclick="editConfig({{ config.id }})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="useConfig({{ config.id }})">
                                <i class="fas fa-play"></i> Use
                            </button>
                            {% if not config.is_default %}
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteConfig({{ config.id }})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <!-- No Configurations -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-cogs fa-4x text-muted mb-4"></i>
                        <h3>No Scan Configurations</h3>
                        <p class="text-muted">Create your first scan configuration to customize security analysis parameters.</p>
                        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createConfigModal">
                            <i class="fas fa-plus"></i> Create First Configuration
                        </button>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Default Configurations Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-4">
                <i class="fas fa-star"></i> Recommended Configurations
            </h3>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Quick Scan</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Fast security assessment for basic vulnerabilities.</p>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Basic port scan (top 100 ports)</li>
                                <li><i class="fas fa-check text-success"></i> SSL/TLS analysis</li>
                                <li><i class="fas fa-check text-success"></i> Security headers check</li>
                                <li><i class="fas fa-times text-muted"></i> Deep vulnerability scan</li>
                            </ul>
                            <button class="btn btn-success btn-sm" onclick="createQuickConfig()">
                                <i class="fas fa-plus"></i> Create Quick Config
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">Comprehensive</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Complete security analysis with all features enabled.</p>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Full port scan (1-65535)</li>
                                <li><i class="fas fa-check text-success"></i> Vulnerability assessment</li>
                                <li><i class="fas fa-check text-success"></i> Web application testing</li>
                                <li><i class="fas fa-check text-success"></i> Threat intelligence</li>
                            </ul>
                            <button class="btn btn-warning btn-sm" onclick="createComprehensiveConfig()">
                                <i class="fas fa-plus"></i> Create Comprehensive Config
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Compliance</h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Focused on regulatory compliance requirements.</p>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Security headers validation</li>
                                <li><i class="fas fa-check text-success"></i> SSL/TLS compliance</li>
                                <li><i class="fas fa-check text-success"></i> OWASP Top 10 checks</li>
                                <li><i class="fas fa-check text-success"></i> Compliance reporting</li>
                            </ul>
                            <button class="btn btn-info btn-sm" onclick="createComplianceConfig()">
                                <i class="fas fa-plus"></i> Create Compliance Config
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Configuration Modal -->
<div class="modal fade" id="createConfigModal" tabindex="-1" aria-labelledby="createConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Create Scan Configuration
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="configForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="configName" class="form-label">Configuration Name</label>
                                <input type="text" class="form-control" id="configName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="configTimeout" class="form-label">Scan Timeout (seconds)</label>
                                <input type="number" class="form-control" id="configTimeout" name="scan_timeout" value="300">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="configDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="configDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="portRange" class="form-label">Port Scan Range</label>
                                <input type="text" class="form-control" id="portRange" name="port_scan_range" value="1-1000">
                                <div class="form-text">Examples: 1-1000, 80,443,8080 or 1-65535</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maxThreads" class="form-label">Max Threads</label>
                                <input type="number" class="form-control" id="maxThreads" name="max_threads" value="10" min="1" max="50">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Enabled Features</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enablePortScan" name="enable_port_scan" checked>
                                    <label class="form-check-label" for="enablePortScan">
                                        Port Scanning
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableVulnScan" name="enable_vulnerability_scan" checked>
                                    <label class="form-check-label" for="enableVulnScan">
                                        Vulnerability Scanning
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableWebAppScan" name="enable_webapp_scan" checked>
                                    <label class="form-check-label" for="enableWebAppScan">
                                        Web Application Scanning
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableSubdomainEnum" name="enable_subdomain_enum" checked>
                                    <label class="form-check-label" for="enableSubdomainEnum">
                                        Subdomain Enumeration
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableThreatIntel" name="enable_threat_intel" checked>
                                    <label class="form-check-label" for="enableThreatIntel">
                                        Threat Intelligence
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isDefault" name="is_default">
                                    <label class="form-check-label" for="isDefault">
                                        Set as Default
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Create Configuration
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Fix for Create Configuration Modal */
#createConfigModal .modal-backdrop {
    background-color: rgba(0, 0, 0, 0.4) !important;
}

#createConfigModal {
    z-index: 1055 !important;
}

#createConfigModal .modal-dialog {
    z-index: 1056 !important;
}

/* Prevent modal freezing */
.modal.show {
    display: flex !important;
    align-items: center;
    justify-content: center;
}

.modal-backdrop.show {
    opacity: 0.4 !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced modal handling using universal system
document.addEventListener('DOMContentLoaded', function() {
    // Use universal cleanup system
    setTimeout(() => {
        if (typeof cleanupModals === 'function') {
            cleanupModals();
        }
    }, 500);
    
    // SIMPLE WORKING MODAL SYSTEM
    const createConfigButtons = document.querySelectorAll('[data-bs-target="#createConfigModal"]');
    createConfigButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const modalElement = document.getElementById('createConfigModal');
            if (modalElement) {
                // FORCE CLEAN EVERYTHING FIRST
                document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
                document.body.classList.remove('modal-open');
                document.body.style.paddingRight = '';
                document.body.style.overflow = '';
                
                // SHOW MODAL WITHOUT SHADOW/BACKDROP
                modalElement.style.cssText = `
                    display: block !important;
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    z-index: 1050 !important;
                    overflow-x: hidden !important;
                    overflow-y: auto !important;
                    background: transparent !important;
                `;
                modalElement.classList.add('show');
                
                // SIMPLE CLOSE HANDLERS (NO BACKDROP)
                const closeModal = () => {
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show');
                    document.body.style.overflow = '';
                };
                
                // Close on ESC
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
                
                // Close on close button
                modalElement.querySelectorAll('[data-bs-dismiss="modal"], .btn-close').forEach(btn => {
                    btn.onclick = closeModal;
                });
                
                // Only prevent backdrop clicks, allow form interactions
                modalElement.onclick = (e) => {
                    if (e.target === modalElement) {
                        closeModal();
                    }
                };
            }
        });
    });
    
    // Handle modal close events with universal cleanup
    const createConfigModal = document.getElementById('createConfigModal');
    if (createConfigModal) {
        createConfigModal.addEventListener('hidden.bs.modal', function() {
            setTimeout(() => {
                if (typeof cleanupModals === 'function') {
                    cleanupModals();
                }
            }, 100);
        });
    }
});

function editConfig(configId) {
    // Create and show edit modal dynamically
    const editModal = createEditModal(configId);
    document.body.appendChild(editModal);
    
    // NO SHADOW MODAL SYSTEM
    // FORCE CLEAN EVERYTHING FIRST
    document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
    document.body.classList.remove('modal-open');
    document.body.style.paddingRight = '';
    document.body.style.overflow = '';
    
    // SHOW MODAL WITHOUT SHADOW/BACKDROP
    editModal.style.cssText = `
        display: block !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 1050 !important;
        overflow-x: hidden !important;
        overflow-y: auto !important;
        background: transparent !important;
    `;
    editModal.classList.add('show');
    
    // SIMPLE CLOSE HANDLERS (NO BACKDROP)
    const closeModal = () => {
        editModal.style.display = 'none';
        editModal.classList.remove('show');
        document.body.style.overflow = '';
        editModal.remove(); // Remove from DOM
    };
    
    // Close on ESC
    const escHandler = (e) => {
        if (e.key === 'Escape') {
            closeModal();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
    
    // Close on close button
    editModal.querySelectorAll('[data-bs-dismiss="modal"], .btn-close').forEach(btn => {
        btn.onclick = closeModal;
    });
    
    // Only prevent backdrop clicks, allow form interactions
    editModal.onclick = (e) => {
        if (e.target === editModal) {
            closeModal();
        }
    };
}

function createEditModal(configId) {
    // Get configuration data (mock data for now)
    const configs = {
        1: { name: 'Quick Security Scan', description: 'Fast assessment', portRange: '80,443', timeout: 120 },
        2: { name: 'Comprehensive Analysis', description: 'Complete analysis', portRange: '1-65535', timeout: 1800 },
        3: { name: 'P4 Security Assessment', description: 'P4 category scanning', portRange: '80,443,8080', timeout: 600 }
    };
    
    const config = configs[configId] || configs[1];
    
    const modalHTML = `
        <div class="modal fade" id="editConfigModal${configId}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-edit"></i> Edit Configuration
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="editConfigForm${configId}">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Configuration Name</label>
                                        <input type="text" class="form-control" value="${config.name}" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Timeout (seconds)</label>
                                        <input type="number" class="form-control" value="${config.timeout}">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" rows="2">${config.description}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Port Range</label>
                                <input type="text" class="form-control" value="${config.portRange}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Enabled Features</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" checked>
                                            <label class="form-check-label">Port Scanning</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" checked>
                                            <label class="form-check-label">Vulnerability Scanning</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" checked>
                                            <label class="form-check-label">Web App Scanning</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox">
                                            <label class="form-check-label">Threat Intelligence</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHTML;
    const modal = tempDiv.firstElementChild;
    
    // Add form submit handler
    const form = modal.querySelector(`#editConfigForm${configId}`);
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        showLoading('Saving Configuration', 'Updating scan configuration...');
        
        setTimeout(() => {
            hideLoading();
            showSuccess(
                'Configuration Updated',
                'Scan configuration has been successfully updated.'
            );
            bootstrap.Modal.getInstance(modal).hide();
        }, 1500);
    });
    
    return modal;
}

function useConfig(configId) {
    showLoading('Loading Configuration', 'Applying scan configuration...');
    
    setTimeout(() => {
        hideLoading();
        showSuccess(
            'Configuration Applied Successfully',
            'The scan configuration has been loaded and is ready to use.'
        );
    }, 1500);
}

function deleteConfig(configId) {
    showConfirm(
        'Delete Configuration',
        'Are you sure you want to delete this scan configuration? This action cannot be undone.',
        () => {
            showLoading('Deleting Configuration', 'Removing scan configuration...');
            
            setTimeout(() => {
                hideLoading();
                showSuccess(
                    'Configuration Deleted',
                    'The scan configuration has been successfully removed.'
                );
            }, 1500);
        }
    );
}

function createQuickConfig() {
    // Pre-fill form with quick scan settings
    document.getElementById('configName').value = 'Quick Scan';
    document.getElementById('configDescription').value = 'Fast security assessment for basic vulnerabilities';
    document.getElementById('portRange').value = '21,22,23,25,53,80,110,143,443,993,995,8080,8443';
    document.getElementById('configTimeout').value = '120';
    document.getElementById('maxThreads').value = '5';
    
    // Enable only basic features
    document.getElementById('enablePortScan').checked = true;
    document.getElementById('enableVulnScan').checked = false;
    document.getElementById('enableWebAppScan').checked = true;
    document.getElementById('enableSubdomainEnum').checked = false;
    document.getElementById('enableThreatIntel').checked = false;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('createConfigModal')).show();
}

function createComprehensiveConfig() {
    // Pre-fill form with comprehensive settings
    document.getElementById('configName').value = 'Comprehensive Scan';
    document.getElementById('configDescription').value = 'Complete security analysis with all features enabled';
    document.getElementById('portRange').value = '1-65535';
    document.getElementById('configTimeout').value = '1800';
    document.getElementById('maxThreads').value = '20';
    
    // Enable all features
    document.getElementById('enablePortScan').checked = true;
    document.getElementById('enableVulnScan').checked = true;
    document.getElementById('enableWebAppScan').checked = true;
    document.getElementById('enableSubdomainEnum').checked = true;
    document.getElementById('enableThreatIntel').checked = true;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('createConfigModal')).show();
}

function createComplianceConfig() {
    // Pre-fill form with compliance settings
    document.getElementById('configName').value = 'Compliance Scan';
    document.getElementById('configDescription').value = 'Focused on regulatory compliance requirements';
    document.getElementById('portRange').value = '80,443,8080,8443';
    document.getElementById('configTimeout').value = '600';
    document.getElementById('maxThreads').value = '10';
    
    // Enable compliance-focused features
    document.getElementById('enablePortScan').checked = true;
    document.getElementById('enableVulnScan').checked = true;
    document.getElementById('enableWebAppScan').checked = true;
    document.getElementById('enableSubdomainEnum').checked = false;
    document.getElementById('enableThreatIntel').checked = true;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('createConfigModal')).show();
}

// Handle form submission
document.getElementById('configForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const configName = document.getElementById('configName').value;
    
    showLoading('Creating Configuration', 'Saving scan configuration...');
    
    setTimeout(() => {
        hideLoading();
        showSuccess(
            'Configuration Created Successfully',
            `Scan configuration "${configName}" has been created and saved.`
        );
        
        // Close modal and reset form
        bootstrap.Modal.getInstance(document.getElementById('createConfigModal')).hide();
        document.getElementById('configForm').reset();
    }, 2000);
});
</script>
{% endblock %}
